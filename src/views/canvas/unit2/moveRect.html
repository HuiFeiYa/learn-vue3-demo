<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>拖拽小方块</title>

    <style>
        #canvas {
            cursor: default;
            border: 1px solid black;
        }
        body{
          /* margin:100px; */
          padding:0;
        }
    </style>
</head>
<body>
<canvas id="canvas" width="400" height="400">Canvas not supported</canvas>
<p>拖拽方块并实时重绘</p>
</body>
<script>
  let canvas = document.getElementById('canvas')
  context = canvas.getContext('2d')
    //初始时的矩形属性
    initX = 10,
  initY = 10,
  initWidth = 100,
  initHeight = 100,

  isDrag = false,
  // 多边形存储
  polygons = {
    fillStyle:'lightgray',
    strokeStyle:'blue',
    // 存储矩形相对于canvas的距离
    loc:{x:0,y:0},
    height:initHeight,
    width:initWidth,
    // 存储鼠标相对于矩形的位置，这关系到绘制矩形的起点问题。
    offsetX:0,
    offsetY:0
  }
  // 绘制矩形形状
  let drawInitRect = () => {
    context.fillStyle = polygons.fillStyle
    context.strokeStyle = polygons.strokeStyle
    context.rect(initX,initY,initWidth,initHeight)
    polygons.loc.x = initX
    polygons.loc.y = initY
    polygons.width = initWidth
    polygons.height = initHeight
    context.fill()
    context.stroke()
  }
  /**
   * 当鼠标按下
   */
  canvas.onmousedown = ev =>{
    isDrag = context.isPointInPath(ev.clientX,ev.clientY)
    /**
     * 计算当前点击位置和 canvas 左上角点的距离。
     * ev.clientX 表示与窗口左上角的距离
     * polygons.loc.x 初始化值是 canvas 绘制元素(也就是矩形)距离canvas左上角的距离
     * 两者相减就是当前鼠标距离 canvas 左上角的距离
     */ 
    polygons.offsetX = ev.clientX - polygons.loc.x - canvas.offsetTop
    polygons.offsetY = ev.clientY - polygons.loc.y - canvas.offsetLeft
    // 保存当前点距离浏览器窗口的位置信息
    polygons.loc.x = ev.clientX
    polygons.loc.y = ev.clientY
    console.log('坐标',ev.clientX,ev.clientY)
    console.log('offset',polygons.offsetX,polygons.offsetY)
  }
  /**
   *  鼠标移动时
   */

   canvas.onmousemove = ev => {
     // 如果用户点击选中了矩形，那么接下来是重新绘制矩形位置的操作
     if(isDrag){
       context.beginPath()
       context.clearRect(0,0,canvas.width,canvas.height)
       context.rect(ev.clientX - polygons.offsetX, ev.clientY - polygons.offsetY, initWidth, initHeight)
       context.fill()
       context.stroke()
     }else{
       /**
        *  如果未选中矩形，判断当前点是否在矩形中，当鼠标划过矩形显示小手表示可移动
        */ 
        if (context.isPointInPath(ev.clientX,ev.clientY)) {
          canvas.style.cursor = 'pointer'
        }else{
          canvas.style.cursor = 'default'
        }
     }
   }
   canvas.onmouseup = ev => {
     isDrag = false
     polygons.loc.x = ev.clientX - polygons.offsetX
     polygons.loc.y = ev.clientY - polygons.offsetY
   }
  drawInitRect()
</script>
</html>